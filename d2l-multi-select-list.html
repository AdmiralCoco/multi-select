<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../d2l-polymer-behaviors/d2l-focusable-arrowkeys-behavior.html">

<dom-module id="d2l-multi-select-list">
	<template strip-whitespace>
		<style>
			:host {
				display: inline-block;
			}

			::slotted(d2l-multi-select-list-item) {
				padding: 0.15rem;
			}

		</style>

		<slot></slot>
	</template>
	<script>
		/**
		 * `<d2l-multi-select-list>`
		 * Polymer-based web component for D2L multi-select-list
		 * @demo demo/index.hmtl
		 */
		class D2LMultiSelectList extends Polymer.mixinBehaviors(
			[
				D2L.PolymerBehaviors.D2LMultiSelect.LocalizeBehavior,
				D2L.PolymerBehaviors.FocusableArrowKeysBehavior,
			],
			Polymer.Element
		) {
			static get is() { return 'd2l-multi-select-list'; }
			static get properties() {
				return {
					/**
					* Keycodes for keyboard behavior
					*/
					_keyCodes: {
						type: Object,
						value: { BACKSPACE: 8, DELETE: 46 }
					},
					/**
					* Tracks the currently focused item for managing tabindex
					*/
					_currentlyFocusedItem: {
						type: Node,
						value: null
					}
				};
			}

			constructor() {
				super();
			}

			connectedCallback() {
				super.connectedCallback();

				Polymer.RenderStatus.afterNextRender(this, () => {
					const listItems = this.getEffectiveChildren();
					// Set up for d2l-focusable-arrowkeys-behavior
					this.arrowKeyFocusablesContainer = this;
					this.arrowKeyFocusablesProvider = () => Promise.resolve(this.getEffectiveChildren());

					// Set tabindex to allow component to be focusable
					if (listItems.length) {
						listItems[0].tabIndex = 0;
						this._currentlyFocusedItem = listItems[0];
					}

					this.addEventListener('blur', this._onListItemBlur, true);
					this.addEventListener('d2l-multi-select-list-item-deleted', this._onListItemDeleted);
					this.addEventListener('focus', this._onListItemFocus, true);
					this.addEventListener('keydown', this._onKeyDown);
				});
			}

			disconnectedCallback() {
				super.disconnectedCallback();
				this.removeEventListener('blur', this._onListItemBlur, true);
				this.removeEventListener('d2l-multi-select-list-item-deleted', this._onListItemDeleted);
				this.removeEventListener('focus', this._onListItemFocus, true);
				this.removeEventListener('keydown', this._onKeyDown);
			}

			_onListItemBlur(event) {
				const listItems = this.getEffectiveChildren();
				const { relatedTarget } = event;

				this._currentlyFocusedItem.tabIndex = -1;

				// Reset tabindex to the first element when the next focused element is not a list item
				if (listItems.indexOf(relatedTarget) === -1) {
					listItems[0].tabIndex = 0;
					this._currentlyFocusedItem = listItems[0];
				}
			}

			_onListItemFocus(event) {
				this._currentlyFocusedItem.tabIndex = -1;
				this._currentlyFocusedItem = event.target;
				this._currentlyFocusedItem.tabIndex = 0;
			}

			_onListItemDeleted(event) {
				event.target.deleteItem();
			}

			_onKeyDown(event) {
				const { BACKSPACE, DELETE } = this._keyCodes;
				const { keyCode } = event;
				const rootTarget = event.composedPath()[0];
				const itemIndex = this.getEffectiveChildren().indexOf(rootTarget);

				if ((keyCode === BACKSPACE || keyCode === DELETE) && itemIndex !== -1) {
					event.preventDefault();
					event.stopPropagation();

					if (keyCode === BACKSPACE) {
						itemIndex === 0
							? this.__focusNext(rootTarget)
							: this.__focusPrevious(rootTarget);
					} else {
						itemIndex === this.getEffectiveChildren().length - 1
							? this.__focusPrevious(rootTarget)
							: this.__focusNext(rootTarget);
					}
					rootTarget.deleteItem();
				}
			}
		}
		customElements.define(D2LMultiSelectList.is, D2LMultiSelectList);
	</script>
</dom-module>
