<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../d2l-polymer-behaviors/d2l-focusable-arrowkeys-behavior.html">

<dom-module id="d2l-multi-select-list">
	<template strip-whitespace>
		<style>
			:host {
				display: inline-block;
			}

			::slotted(d2l-multi-select-list-item) {
				padding: 0.15rem;
			}

		</style>

		<slot></slot>
	</template>
	<script>
		/**
		 * `<d2l-multi-select-list>`
		 * Polymer-based web component for D2L multi-select-list
		 * @demo demo/index.hmtl
		 */
		class D2LMultiSelectList extends Polymer.mixinBehaviors(
			[
				D2L.PolymerBehaviors.D2LMultiSelect.LocalizeBehavior,
				D2L.PolymerBehaviors.FocusableArrowKeysBehavior,
			],
			Polymer.Element
		) {
			static get is() { return 'd2l-multi-select-list'; }
			static get properties() {
				return {
					/**
					* The list of multi-select-list-items.
					*/
					_items: {
						type: Array,
						value: []
					},

					_keyCodes: {
						type: Object,
						value: { BACKSPACE: 8, DELETE: 46 }
					},
				};
			}

			constructor() {
				super();
			}

			connectedCallback() {
				super.connectedCallback();

				Polymer.RenderStatus.afterNextRender(this, () => {
					// Set up for d2l-focusable-arrowkeys-behavior
					this.arrowKeyFocusablesContainer = this;
					this.arrowKeyFocusablesProvider = () => Promise.resolve(this.getEffectiveChildren());

					this.tabIndex = 0; // Set tabindex to allow component to be focusable
					this.addEventListener('keydown', this._onKeyDown);
					this.addEventListener('focus', this._onFocus);
					this.addEventListener('d2l-multi-select-list-item-deleted', this._onListItemDeleted);

				});
			}

			disconnectedCallback() {
				super.disconnectedCallback();
				this.removeEventListener('keydown', this._onKeyDown);
				this.removeEventListener('focus', this._onFocus);
				this.removeEventListener('d2l-multi-select-list-item-deleted', this._onListItemDeleted);
			}

			_onFocus(event) {
				// Only focus if triggered from an element that isn't part of the list
				if (this.getEffectiveChildren().indexOf(event.relatedTarget) === -1) {
					this.__focusFirst();
				}
			}

			_onListItemDeleted(event) {
				event.target.deleteItem();
			}

			_onKeyDown(event) {
				const rootTarget = event.composedPath()[0];
				const { keyCode } = event;

				if (keyCode === this._keyCodes.BACKSPACE || keyCode === this._keyCodes.DELETE) {
					event.preventDefault();
					event.stopPropagation();

					if (this.getEffectiveChildren().indexOf(rootTarget)  !== -1) {
						keyCode === this._keyCodes.BACKSPACE
							? this.__focusPrevious(rootTarget)
							: this.__focusNext(rootTarget);
						rootTarget.deleteItem();
					}
				}
			}
		}
		customElements.define(D2LMultiSelectList.is, D2LMultiSelectList);
	</script>
</dom-module>
